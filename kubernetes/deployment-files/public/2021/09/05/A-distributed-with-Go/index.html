<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>A distributed system with Go | Farmer</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.1.0"><link rel="stylesheet" type="text/css" href="/css/dark.css?v=1.1.0"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.1.0/pure-min.min.css"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pure/2.1.0/grids-responsive-min.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + 'b9d3811fb8d19b04438737cb71b15c9e';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.10/clipboard.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">ğŸŒ“</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">A distributed system with Go</h1><a id="logo" href="/.">Farmer</a><p class="description">-Farmerçš„è‡ªä¹ å®¤</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/readings/"><i class="fa fa-bookmark"> é˜…è¯»æ¸…å•</i></a><a href="/history/"><i class="fa fa-book"> å†å²</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">A distributed system with Go</h1><div class="post-meta">2021-09-05<span> | </span><span class="category"><a href="/categories/%E6%90%9E%E4%BA%8B%E6%83%85/">æäº‹æƒ…</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 2.6k</span><span class="post-meta-item-text"> å­—</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 11</span><span class="post-meta-item-text"> åˆ†é’Ÿ</span></span></span></div><div class="post-content"><p>ä»ä¸Šå­¦æœŸå¼€å§‹ï¼Œå­¦æ ¡çš„æ•™åŠ¡ç³»ç»Ÿæ›´æ–°äº†ã€‚æ–°ç‰ˆçš„æ­£æ–¹å¤šäº†ä¸€ä¸ªè´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œä½†æ— å¥ˆå®åœ¨åšçš„å¤ªå·®äº†ï¼ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å°¼ï¼Ÿ<br>å› ä¸ºåœ¨ä¸Šå­¦æœŸæŠ¢è¯¾çš„æ—¶å€™å…¥å£ç½‘å…³ä¾æ—§æ‹‰é—¸ï¼Œè€ŒçœŸæ­£çš„åç«¯æœåŠ¡å™¨è®¿é—®é€Ÿåº¦æ¯”å¾·èŠ™è¿˜ä¸æ»‘ã€‚å› æ­¤æš‚å°†é”…ç”©ç»™è´Ÿè½½å‡è¡¡æœåŠ¡å™¨ã€‚æ—¢ç„¶å­¦æ ¡çš„è´Ÿè½½å‡è¡¡æ‹‰é—¸ï¼Œé‚£ä¹ˆå°±æœ‰äº† <strong>â€œå¸®å­¦æ ¡åšè´Ÿè½½å‡è¡¡â€</strong> çš„æƒ³æ³•ã€‚<br>å¤§ä½“çš„æ€è·¯å°±æ˜¯ï¼Œé€šè¿‡æ‰«æå†…ç½‘ç½‘æ®µå‘ç°éšè—çš„åœ°å€ï¼Œç„¶åè´Ÿè½½å‡è¡¡è¿™äº›éšè—çš„åœ°å€ã€‚<br>æ—¢ç„¶æ˜¯è´Ÿè½½å‡è¡¡ï¼Œç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯<code>Nginx</code>äº†ï¼Œé€šè¿‡èµ„æ–™æœé›†ï¼Œå¤§è‡´ç¡®å®šäº†åŸºæœ¬çš„æµç¨‹ï¼Œå› æ­¤æœ‰äº†è¿™ä¹ˆçš„è¿™ä¸ªæµç¨‹å›¾:</p>
<img src="/2021/09/05/A-distributed-with-Go/floatChart.dio.png" class="" title="floatChart">

<a id="more"></a>

<h2 id="éœ€è¦è§£å†³çš„é—®é¢˜"><a href="#éœ€è¦è§£å†³çš„é—®é¢˜" class="headerlink" title="éœ€è¦è§£å†³çš„é—®é¢˜"></a>éœ€è¦è§£å†³çš„é—®é¢˜</h2><p>ç”±äºéå®˜æ–¹çš„ä»£ç†ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•çŸ¥é“æ•™åŠ¡ç³»ç»Ÿéƒ¨ç½²åœ¨å†…ç½‘çš„å“ªäº›æœºå™¨ä¸Šï¼Œè€Œæ ¡å›­ç½‘ä¸€èˆ¬ä½¿ç”¨Bç±»ç½‘ï¼Œå› æ­¤éœ€è¦æ‰«æå¤§é‡çš„ipåœ°å€ã€‚<br>ä½†è¿™æ ·æ— ç–‘ä¼šè§¦å‘å­¦æ ¡ç½‘ç®¡çš„æŠ¥è­¦ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šå¯¼è‡´ipçŸ­æ—¶é—´å†…è¢«å°ã€‚å¯¼è‡´æ‰«æè´¨é‡ä½ï¼ˆç”±äºè¢«ç¦ç½‘ï¼Œå¯¼è‡´ç¨‹åºè¯¯è®¤ä¸ºæ‰«æè¶…æ—¶ä»è€Œå¯¼è‡´ç›®æ ‡æœªè¢«å‘ç°ï¼‰ã€‚<br>åŸºäºè¿™ä¸ªé—®é¢˜ï¼Œéšä¹‹è€Œç”Ÿçš„æƒ³æ³•å°±æ˜¯åˆ†å¸ƒå¼æ‰«æï¼Œå°†æ‰«æçš„å·¥ä½œæ‰“æ•£åˆ°ç”¨æˆ·ä¸­ï¼ŒæœåŠ¡å™¨åªè´Ÿè´£æ‰«æå‡ ä¸ªä¸»å¹²ç½‘æ®µã€‚<br>ä¸€å¥è¯æ¦‚æ‹¬å°±æ˜¯: <strong>å°†æ‰«æå·¥ä½œåˆ†æ•£åˆ°å¤šå°æœºå™¨ä¸Š</strong>ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<img src="/2021/09/05/A-distributed-with-Go/microService.dio.png" class="" title="microService">


<h2 id="Todo"><a href="#Todo" class="headerlink" title="Todo"></a>Todo</h2><blockquote>
<p>å‰æƒ…æç¤º: æœ¬æ–‡é€šä¿¡å‡é‡‡ç”¨HTTPã€ä»£ç éƒ¨åˆ†å­˜åœ¨ä¼ªä»£ç <br>ä»£ç ä»“åº“: (æš‚ä¸å¼€æº)</p>
</blockquote>
<ol>
<li>æ³¨å†Œä¸­å¿ƒ -&gt; <strong>æœåŠ¡æ³¨å†Œ</strong>ä¸<strong>æœåŠ¡å‘ç°</strong></li>
<li>æ—¥å¿—æœåŠ¡ -&gt; è®°å½•æ—¥å¿—</li>
<li>æ•°æ®åº“æœåŠ¡ -&gt; æ•°æ®åº“æ“ä½œ(CRUD)</li>
<li>æ‰«æå™¨æœåŠ¡ -&gt; å‘ç°æ•™åŠ¡ç³»ç»Ÿåœ°å€</li>
<li>æµ‹è¯•å™¨æœåŠ¡ -&gt; æµ‹è¯•æ•°æ®åº“ä¸­åœ°å€çš„<strong>å¥åº·åº¦</strong></li>
<li>ApiæœåŠ¡ -&gt; å‘<code>consul</code>å‘é€è´Ÿè½½ä¿¡æ¯</li>
</ol>
<p>å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š</p>
<img src="/2021/09/05/A-distributed-with-Go/scanner.dio.png" class="" title="scanner">


<h2 id="æ³¨å†Œä¸­å¿ƒ"><a href="#æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="æ³¨å†Œä¸­å¿ƒ"></a>æ³¨å†Œä¸­å¿ƒ</h2><p>ä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œä¸å¯é¿å…åœ°éœ€è¦<strong>æœåŠ¡æ³¨å†Œ</strong>ä¸<strong>æœåŠ¡å‘ç°</strong>ã€‚å› æ­¤éœ€è¦ä¸€ä¸ª<code>æ³¨å†Œä¸­å¿ƒ</code>æ¥å¤„ç†å„ä¸ª<code>æœåŠ¡</code>ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œåœ¨æœåŠ¡ä¸Šçº¿åé€šçŸ¥ä¾èµ–è¿™ä¸ªæœåŠ¡çš„æœåŠ¡(è¿™é‡Œæœ‰ç‚¹ç»•)<br><strong>ä¸¾ä¸ªä¾‹å­</strong>:<br><code>æ•°æ®åº“</code>çš„æ¯ä¸ªæ“ä½œéƒ½éœ€è¦è®°å½•æ—¥å¿—ï¼Œæ—¥å¿—ä¸ºäº†ç»Ÿä¸€ç®¡ç†æ‰€ä»¥æœ‰ä¸€ä¸ª<code>æ—¥å¿—æœåŠ¡</code>ä¸“é—¨å¤„ç†æ—¥å¿—ä¿¡æ¯ã€‚æ­¤æ—¶ï¼Œ<code>æ—¥å¿—æœåŠ¡</code>å› æŸäº›åŸå› (å¯èƒ½æ˜¯äººä¸ºã€ä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œæ‰çº¿ç­‰)åœ¨<code>æ•°æ®åº“æœåŠ¡</code>æ³¨å†Œä¹‹åæ‰æ³¨å†Œï¼Œè¿™æ˜¯<code>æ³¨å†Œä¸­å¿ƒ</code>å°±éœ€è¦é€šçŸ¥<code>æ•°æ®åº“</code>ï¼Œè®©<code>æ•°æ®åº“</code>çš„æ—¥å¿—è®°å½•è½¬æˆä½¿ç”¨<code>æ—¥å¿—æœåŠ¡</code>ã€‚</p>
<h3 id="åŠŸèƒ½ä¸å®ç°"><a href="#åŠŸèƒ½ä¸å®ç°" class="headerlink" title="åŠŸèƒ½ä¸å®ç°"></a>åŠŸèƒ½ä¸å®ç°</h3><p>ä½œä¸ºä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªwebæœåŠ¡æ¥æ¥æ”¶æœåŠ¡å‘é€çš„ä¿¡æ¯(æ³¨å†Œã€ä¾èµ–æ›´æ–°ã€æ³¨é”€ç­‰ç­‰)ï¼Œä½†åœ¨è¿™ä¹‹å‰æˆ‘ä»¬å…ˆæ¥å®šä¹‰ä¸€ä¸‹æˆ‘ä»¬è¦ç”¨åˆ°çš„ç»“æ„(åœ¨é¢å‘å¯¹è±¡ä¸­ä¸ºç±»)</p>
<ol>
<li><code>registry</code>æ¥è¡¨ç¤ºæ³¨å†Œæ“ä½œ<ul>
<li><code>registrations</code>æ¥å­˜æ”¾æ³¨å†Œçš„æœåŠ¡</li>
<li><code>add</code> æ³¨å†ŒæœåŠ¡</li>
<li><code>notify</code> äº‹ä»¶é€šçŸ¥</li>
<li><code>sendRequiredServices</code> å‘é€ä¾èµ–çš„æœåŠ¡</li>
<li><code>sendPatch</code> å‘é€ä¾èµ–é¡¹</li>
<li><code>remove</code> ç§»é™¤(æ³¨é”€)æœåŠ¡</li>
<li><code>Heartbeat</code> å¿ƒè·³åŒ…</li>
</ul>
</li>
<li><code>Registration</code>è¡¨ç¤ºæœåŠ¡æ³¨å†Œç»“æ„ä½“<ul>
<li><code>ServiceName</code> æœåŠ¡å</li>
<li><code>ServiceURL</code> æœåŠ¡åœ°å€</li>
<li><code>RequiredServices</code>[æ•°ç»„]æœåŠ¡ä¾èµ–é¡¹</li>
<li><code>ServiceUpdateURL</code> æœåŠ¡ä¸æ³¨å†Œä¸­å¿ƒæ²Ÿé€šçš„URL</li>
<li><code>HeartbeatURL</code> å¿ƒè·³æ£€æµ‹åœ°å€</li>
</ul>
</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> registry <span class="keyword">struct</span> &#123;</span><br><span class="line">	registrations []Registration</span><br><span class="line">	mutex         *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æœåŠ¡æ³¨å†Œç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Registration <span class="keyword">struct</span> &#123;</span><br><span class="line">	ServiceName ServiceName</span><br><span class="line">	ServiceURL  <span class="keyword">string</span></span><br><span class="line">	RequiredServices []ServiceName</span><br><span class="line">	ServiceUpdateURL <span class="keyword">string</span></span><br><span class="line">	HeartbeatURL     <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ServiceName <span class="keyword">string</span></span><br><span class="line"><span class="comment">// æ·»åŠ æ³¨å†Œ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *registry)</span> <span class="title">add</span><span class="params">(reg Registration)</span> <span class="title">error</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ä¾èµ–æœåŠ¡è¿è¡Œæ—¶ï¼Œé€šçŸ¥ä¾èµ–è€…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r registry)</span> <span class="title">notify</span><span class="params">(fullpatch patch)</span></span> </span><br><span class="line"><span class="comment">// æ³¨å†Œä¸­å¿ƒå‘æœåŠ¡å‘é€ä¾èµ–ç›¸å…³å†…å®¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r registry)</span> <span class="title">sendRequiredServices</span><span class="params">(reg Registration)</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">// å‘é€ä¾èµ–é¡¹</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r registry)</span> <span class="title">sendPatch</span><span class="params">(p patch, url <span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">// ç§»é™¤æ³¨å†Œï¼ˆæ³¨é”€ï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *registry)</span> <span class="title">remove</span><span class="params">(url <span class="keyword">string</span>)</span> <span class="title">error</span></span></span><br><span class="line"><span class="comment">// å¿ƒè·³åŒ…</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *registry)</span> <span class="title">Heartbeat</span><span class="params">(freq time.Duration)</span></span></span><br></pre></td></tr></table></figure>

<p>æ—¢ç„¶æ³¨å†Œä¸­å¿ƒæ˜¯ä½œä¸ºä¸€ä¸ªwebæœåŠ¡å®ç°çš„ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯éœ€è¦ä¸€ä¸ª<code>web server</code>çš„ï¼Œç”±äºé¡¹ç›®å±äºç©ç¥¨æ€§è´¨ï¼Œä¹Ÿä¸ç®—å¤§å› æ­¤ä½¿ç”¨Goå†…ç½®çš„<code>net/http</code>æ¥å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RegistryService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s RegistryService)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"Request received"</span>)</span><br><span class="line">	<span class="keyword">switch</span> r.Method &#123;</span><br><span class="line">	<span class="keyword">case</span> http.MethodPost:</span><br><span class="line">		decoder := json.NewDecoder(r.Body)</span><br><span class="line">		<span class="keyword">var</span> r Registration</span><br><span class="line">		err := decoder.Decode(&amp;r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">"Adding service: %v with URL: %s\n"</span>, r.ServiceName, r.ServiceURL)</span><br><span class="line">		err = reg.add(r)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusBadRequest)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">case</span> http.MethodDelete:</span><br><span class="line">		payload, err := ioutil.ReadAll(r.Body)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		url := <span class="keyword">string</span>(payload)</span><br><span class="line">		log.Printf(<span class="string">"Removing service at URL: %s"</span>, url)</span><br><span class="line">		err = reg.remove(url)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">			w.WriteHeader(http.StatusInternalServerError)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		w.WriteHeader(http.StatusMethodNotAllowed)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h2 id="æœåŠ¡ç»„ä»¶"><a href="#æœåŠ¡ç»„ä»¶" class="headerlink" title="æœåŠ¡ç»„ä»¶"></a>æœåŠ¡ç»„ä»¶</h2><p>å¯¹æœåŠ¡æ¥è¯´ï¼Œå°±æ˜¯æ ¹æ®æ³¨å†Œä¸­å¿ƒå®šå¥½çš„è§„åˆ™æ¥æ³¨å†ŒæœåŠ¡ï¼Œç„¶åæ ¹æ®è‡ªèº«çš„ä¾èµ–æ¥å¤„ç†å¯¹åº”çš„åŠŸèƒ½ã€‚<br>å› ä¸ºè¦å¤„ç†ç›¸åº”çš„ä¾èµ–ï¼Œå› æ­¤é™¤äº†<code>Registration</code>å¤–ï¼Œå†å®šä¹‰ä¸€ä¸ªå¤„ç†æœåŠ¡ä¾èµ–çš„ç»“æ„ä½“åŠæ–¹æ³•: <code>providers</code>.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> providers <span class="keyword">struct</span> &#123;</span><br><span class="line">	services <span class="keyword">map</span>[ServiceName][]<span class="keyword">string</span>   <span class="comment">// æœåŠ¡å-&gt;æœåŠ¡url</span></span><br><span class="line">	mutex    *sync.RWMutex</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ›´æ–°ä¾èµ–</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *providers)</span> <span class="title">Update</span><span class="params">(pat patch)</span></span></span><br><span class="line"><span class="comment">// // é€šè¿‡æœåŠ¡åç§°ï¼Œæ‰¾åˆ°ä¾èµ–çš„urlsï¼Œä»ä¾èµ–é¡¹é‡Œé¢éšæœºè¿”å›ä¸€ä¸ªurl</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p providers)</span> <span class="title">get</span><span class="params">(name ServiceName)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span></span><br><span class="line"><span class="comment">// å¯¼å‡ºç»™å¤–éƒ¨ä½¿ç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetProvide</span><span class="params">(name ServiceName)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span></span><br></pre></td></tr></table></figure>

<h3 id="ç»„ä»¶çš„webæœåŠ¡"><a href="#ç»„ä»¶çš„webæœåŠ¡" class="headerlink" title="ç»„ä»¶çš„webæœåŠ¡"></a>ç»„ä»¶çš„webæœåŠ¡</h3><p>å› ä¸ºæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ä½¿ç”¨<strong>æ³¨å†Œ</strong>è¿™äº›é€šç”¨çš„åŠŸèƒ½ï¼Œä¸”è¿™éƒ¨åˆ†çš„å·¥ä½œéƒ½æ˜¯é‡å¤çš„ï¼Œå› æ­¤å°†webæŠ½å‡ºæ¥å…¬ç”¨.</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(ctx context.Context, host, port <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	reg registry.Registration,</span></span></span><br><span class="line"><span class="function"><span class="params">	RegisterHandlersFunc <span class="keyword">func</span>()</span>) <span class="params">(context.Context, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	RegisterHandlersFunc()</span><br><span class="line">	ctx = startService(ctx, reg.ServiceName, host, port)</span><br><span class="line">	err := registry.RegisterService(reg)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ctx, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ctx, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startService</span><span class="params">(ctx context.Context, ServiceName registry.ServiceName,</span></span></span><br><span class="line"><span class="function"><span class="params">	host, port <span class="keyword">string</span>)</span> <span class="title">context</span>.<span class="title">Context</span></span> &#123;</span><br><span class="line">	ctx, cancel := context.WithCancel(ctx)</span><br><span class="line">	<span class="keyword">var</span> srv http.Server</span><br><span class="line">	srv.Addr = <span class="string">":"</span> + port</span><br><span class="line">	address := fmt.Sprintf(<span class="string">"http://%s:%s"</span>, host, port)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		log.Println(srv.ListenAndServe())</span><br><span class="line">		<span class="comment">// å…³é—­çš„æ—¶å€™è¦å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">		<span class="comment">// ... todo</span></span><br><span class="line">		err := registry.ShutdownService(address)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">		&#125;</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"Service is running in %v\n"</span>, address)</span><br><span class="line">		fmt.Println(<span class="string">"Registry service started. Press any key to stop."</span>)</span><br><span class="line">		<span class="keyword">var</span> s <span class="keyword">string</span></span><br><span class="line">		fmt.Scanln(&amp;s)</span><br><span class="line">		srv.Shutdown(ctx)</span><br><span class="line">		err := registry.ShutdownService(address)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">		&#125;</span><br><span class="line">		cancel()</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">return</span> ctx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è‡³æ­¤ï¼Œå¯ä»¥å¼€å§‹ä¸“å¿ƒçš„å†™ä¸šåŠ¡äº†</p>
</blockquote>
<h3 id="æ‰«æå™¨"><a href="#æ‰«æå™¨" class="headerlink" title="æ‰«æå™¨"></a>æ‰«æå™¨</h3><p>å¾—ç›ŠäºGoé«˜å¹¶å‘çš„ä¼˜åŠ¿ï¼Œå¼€å¯æ•°ç™¾ä¸‡ä¸ªçš„<code>goroutine</code>çš„å¼€é”€ä¹Ÿä¸ä¼šå¾ˆå¤§ï¼Œéå¸¸çš„è½»é‡ï¼ğŸ›«<br>å› æ­¤ä»£ç å®ç°èµ·æ¥å¾ˆè½»æ¾ï¼Œå¤§ä½“æ€è·¯å’Œ<strong>ç«¯å£æ‰«æå™¨</strong>ç±»ä¼¼ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæ ¹æ®ç›®æ ‡ç‰¹å¾æ·»åŠ åˆ¤æ–­æ¡ä»¶å³å¯<br>ç«¯å£æ‰«æå™¨ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(ports <span class="keyword">chan</span> <span class="keyword">int</span>, results <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> p := <span class="keyword">range</span> ports &#123;</span><br><span class="line">		address := fmt.Sprintf(<span class="string">"192.168.2.122:%d"</span>, p)</span><br><span class="line">		fmt.Printf(<span class="string">"start %s\n"</span>, address)</span><br><span class="line">		conn, err := net.DialTimeout(<span class="string">"tcp"</span>, address, time.Second*<span class="number">5</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			results &lt;- <span class="number">0</span></span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		conn.Close()</span><br><span class="line">		results &lt;- p</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	ports := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">30000</span>)</span><br><span class="line">	results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">100</span>)</span><br><span class="line">	scanEndPort := <span class="number">65535</span></span><br><span class="line">	<span class="keyword">var</span> openPorts []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(ports); i++ &#123;</span><br><span class="line">		<span class="keyword">go</span> worker(ports, results)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// push port to channel</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= scanEndPort; i++ &#123;</span><br><span class="line">			ports &lt;- i</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">close</span>(ports)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= scanEndPort; i++ &#123;</span><br><span class="line">		res := &lt;-results</span><br><span class="line">		<span class="keyword">if</span> res != <span class="number">0</span> &#123;</span><br><span class="line">			openPorts = <span class="built_in">append</span>(openPorts, res)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">close</span>(results)</span><br><span class="line">	sort.Ints(openPorts)</span><br><span class="line">	<span class="keyword">for</span> _, port := <span class="keyword">range</span> openPorts &#123;</span><br><span class="line">		fmt.Printf(<span class="string">"%d opend\n"</span>, port)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>








<h3 id="æµ‹è¯•å™¨"><a href="#æµ‹è¯•å™¨" class="headerlink" title="æµ‹è¯•å™¨"></a>æµ‹è¯•å™¨</h3><p>æµ‹è¯•å™¨ä¸»è¦åŠŸèƒ½æ˜¯ä»æ•°æ®åº“ä¸­å–å‡ºæ•™åŠ¡ç³»ç»Ÿåœ°å€ï¼Œç„¶åæµ‹è¯•ã€‚ä¸æ‰«æå™¨ä¸åŒä»…åœ¨äºæ‰«æå™¨æ˜¯å†™ï¼Œæµ‹è¯•å™¨æ˜¯è¯»ã€‚å› æ­¤è¿™éƒ¨åˆ†å†…å®¹å’Œæ‰«æå™¨å®é™…ä¸Šæ˜¯åœ¨åŒä¸ªåŒ…å†…çš„ï¼Œåªæ˜¯é€»è¾‘ä¸Šå°†å®ƒåˆ†ç¦»äº†å‡ºæ¥ã€‚   </p>
<p>è¿™éƒ¨åˆ†å…¶å®å’Œ<code>consul</code>çš„åŠŸèƒ½æ˜¯é‡å¤çš„ï¼Œå› æ­¤ä»£ç ä¸è¿‡å¤šèµ˜è¿°</p>
<h3 id="æ•°æ®åº“"><a href="#æ•°æ®åº“" class="headerlink" title="æ•°æ®åº“"></a>æ•°æ®åº“</h3><p>ç”±äºæ ¡å›­ç½‘ä¸­ï¼Œæ•™åŠ¡ç³»ç»Ÿçš„åœ°å€ä¸ä¼šå¤ªå¤šï¼Œå› æ­¤æ•°æ®åº“çš„é€‰æ‹©ååˆ†çš„éšæ„(ä¸å­˜åœ¨æ€§èƒ½æ–¹é¢çš„è¦æ±‚),æ‰€ä»¥è¿™é‡Œä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„<code>redis</code>ä½œä¸ºæ•°æ®åº“ã€‚<br><strong>ç”±äºæœ¬ç³»ç»Ÿæ˜¯å’Œå®˜æ–¹çš„è´Ÿè½½å‡è¡¡å¹¶è¡Œçš„</strong> å› æ­¤å­˜åœ¨æŸäº›ç»“ç‚¹ç”¨äºä¸¤è€…å…±åŒè®¿é—®å¯¼è‡´å‹åŠ›ä¸Šæ¶¨ï¼Œå“åº”ä¸åŠæ—¶ï¼Œå› æ­¤åˆ©ç”¨<code>redis</code>çš„<code>sorted-set</code>åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œå°†å“åº”å¿«çš„åœ°å€è®¾ç½®é«˜åˆ†æ•°ï¼Œä½¿ç”¨<code>sorted-sets</code>çš„å¥½å¤„è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ï¼Œé›†åˆçš„å…ƒç´ éƒ½æ˜¯ä¸é‡å¤çš„ï¼ï¼Œå¯¹äºä»£ç†æ± æ¥è¯´ï¼Œè¿™ä¸ªåˆ†æ•°ä»£è¡¨ç€æ•™åŠ¡ç³»ç»Ÿåœ°å€ç¨³å®šæ€§çš„é‡è¦æ ‡å‡†ï¼Œå› æ­¤è®¾ç½®åˆ†æ•°çš„è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
<li>åŸºæœ¬åˆ†ï¼š10åˆ†ï¼Œæœ€é«˜åˆ†ï¼š20</li>
<li>æµ‹è¯•å™¨è®¾ç½®ä¸€ä¸ªæ›´ä¸¥æ ¼çš„è¶…æ—¶æ—¶é—´æ¥åˆ¤æ–­ç»“ç‚¹æ˜¯å¦æµç•…</li>
<li>åˆ†æ•°<strong>åŸºæœ¬åˆ†</strong>ä¸ºå¯ç”¨ï¼Œæ£€æµ‹å™¨ä¼šå®šæ—¶å¾ªç¯æ£€æµ‹æ¯ä¸ªä»£ç†å¯ç”¨æƒ…å†µï¼Œä¸€æ—¦æ£€æµ‹åˆ°æœ‰å¯ç”¨çš„ä»£ç†åˆ™ç«‹å³ç½®ä¸º<strong>æœ€é«˜åˆ†</strong></li>
<li>æ–°è·å–çš„ä»£ç†åˆ†æ•°è®¾ç½®ä¸º<strong>åŸºæœ¬åˆ†</strong>ï¼Œå¦‚æœæµ‹è¯•å¯è¡Œ(æµç•…)åˆ™ç½®ä¸ºæ»¡åˆ†ï¼Œä¸å¯è¡Œ(è¶…æ—¶)åˆ™åˆ†æ•°å‡ä¸€</li>
<li>åˆ†æ•°å‡åˆ°0åä»£ç†ç§»é™¤</li>
</ul>
<p>ç”±äºæ˜¯å†…ç½‘ç¯å¢ƒï¼Œåˆ†æ•°ä¸è¶…æ—¶æ—¶é—´å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè®¾ç½®æ›´ä¸¥æ ¼</p>
<p>ä¸»è¦åŠŸèƒ½å°±æ˜¯ç®€å•çš„CRUDå•¦ï¼Œæœ¬æ–‡åªè®²é€»è¾‘ä¸ä¼ªä»£ç ï¼Œå®ç°éƒ¨åˆ†å°±ä¸å¤šè¯´äº†ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set jwglxt to max score</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">max</span><span class="params">(addr discover.Addr)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	member, err := addr.MarshalBinary()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	err = rdb.ZAdd(ctx, redisConfig.Key, &amp;redis.Z&#123;</span><br><span class="line">		Score:  SCORE_MAX,</span><br><span class="line">		Member: member,</span><br><span class="line">	&#125;).Err()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// decrease proxy score</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decrease</span><span class="params">(addr discover.Addr)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	member, err := addr.MarshalBinary()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	err = rdb.ZIncrBy(ctx, redisConfig.Key, <span class="number">-1</span>, <span class="keyword">string</span>(member)).Err()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	score := rdb.ZScore(ctx, redisConfig.Key, <span class="keyword">string</span>(member))</span><br><span class="line">	<span class="keyword">if</span> score.Val() &lt;= <span class="number">0.00</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"%v current score %v, remove.\n"</span>, addr, score.Val())</span><br><span class="line">		err := rdb.ZRem(ctx, redisConfig.Key, member).Err()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// add new proxy to redis</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(addrs discover.Addrs)</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, addr := <span class="keyword">range</span> addrs &#123;</span><br><span class="line">		buf, err := addr.MarshalBinary()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		err = rdb.ZAdd(ctx, redisConfig.Key, &amp;redis.Z&#123;</span><br><span class="line">			Score:  SCORE_DEFAULT,</span><br><span class="line">			Member: buf,</span><br><span class="line">		&#125;).Err()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="consul-upsync-nginxå®ç°åŠ¨æ€è´Ÿè½½å‡è¡¡"><a href="#consul-upsync-nginxå®ç°åŠ¨æ€è´Ÿè½½å‡è¡¡" class="headerlink" title="consul-upsync-nginxå®ç°åŠ¨æ€è´Ÿè½½å‡è¡¡"></a>consul-upsync-nginxå®ç°åŠ¨æ€è´Ÿè½½å‡è¡¡</h2><p>è¯¥éƒ¨åˆ†å¯ä»¥è¯´æ˜¯ç³»ç»Ÿå®ç°çš„å…³é”®äº†ï¼Œå› ä¸º<code>nginx</code>è‡ªå¸¦çš„è´Ÿè½½å‡è¡¡æ˜¯å†™æ­»çš„ï¼Œä¸èƒ½æ ¹æ®åç«¯æƒ…å†µåŠ¨æ€è°ƒæ•´ï¼Œé€šè¿‡ä¸€ç•ªæœç´¢å¯¹æ¯”ï¼Œæœ€ç»ˆå†³å®šäº†<code>consul</code> + <code>upsync</code>æ–¹æ¡ˆã€‚   </p>
<ol>
<li><code>upsync</code> ä¸€ä¸ªNginxçš„æ¨¡å—(æ‰©å±•)</li>
<li><code>consul</code> ä¸€ä¸ªåˆ†å¸ƒå¼é«˜å¯ç”¨çš„ç³»ç»Ÿ</li>
</ol>
<p>è¿™éƒ¨åˆ†ä»…é™äºâ€œèƒ½ç”¨â€é˜¶æ®µï¼Œç¬”è€…ä¹Ÿä¸å¤ªæ‡‚ï¼Œå°±ä¸ä¹±è¯´å•¦ï¼<br>ä¸»è¦å°±æ˜¯<strong>ApiæœåŠ¡</strong>å®šæ—¶çš„è·å–æ•°æ®åº“å†…å®¹(åˆ†æ•°ä½œä¸ºæƒé‡)ï¼Œç„¶åæ¨é€åˆ°<strong>consul</strong>ä¸­</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯¥é¡¹ç›®æ˜¯å­¦ä¹ Goæ—¶çš„ä¸€ä¸ªç»ƒæ‰‹é¡¹ç›®ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ä¸å¤ªå¥½ï¼Œå› æ­¤ä»“åº“å°±ä¸å¼€æºäº†ğŸ•</p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="å¤åˆ¶æˆåŠŸ!"></script><a class="pos-f tr3" id="github" href="https://github.com/farmerChillax" target="_blank" rel="noopener" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/AliPayQR.jpg"></li><li id="WeChat" qr="/img/WeChatQR.jpg"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><script type="text/javascript" src="/js/share.js?v=1.1.0" async></script><a class="article-share-link" data-url="https://blog.farmer233.top/2021/09/05/A-distributed-with-Go/" data-id="cl3kx4azw000gmd321xtw1ldt" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMElEQVR42u3aS47CQAwFQO5/aWaLNEzzbIeR0l1ZIURCVxaWf49HfD1frtdvkt+v7/39ef3k0YWBgXFbxnN5/fWbHLN+EQlyfTYMDIxzGMkh1vjkENWAm5wNAwMDY83Iv0mOiIGBgfE9RpJQTtJHDAwMjLyITZDVQ+fJ4mW1OAYGxg0Zedf9/z9/Zb6BgYFxK8azeFXvWieOvTO8eRoGBsbWjDzA5clZnrpNAi4GBsZpjKtaZvldSQhOGoKP/NEYGBi3ZeQNrLxZn6+C5anhhxECBgbGAYxJIK4erjo0jV4ZBgbG1oxrlx5y6oQdzWMxMDC2Y1RD27q5n5PmgbvQ58PAwLgto9eaz1v/1XZetdH2JsPFwMDYjjFfd6gG6B4+KnExMDAOYOTNtV7RW+UlC2RRPY2BgXFzRu+46wSxOoxMks7CsgUGBsZ2jElpWi1EJ+lmYcCJgYFxAOOqwDoJ4r1yFwMDY1dGrynfC6BJeK2ud2BgYJzAmJeU+brYpAItJ4UYGBibMnrp3aShPwnc5WULDAyMLRjV0rQ3zuyNNtevAAMD4xzGvCmWH2jSF/xQxGJgYGzHmCdneXJZXfi4LLfFwMC4OaMa5noLGdW/7wV3DAyMvRm9Jlc+HugxqotiGBgYJzB6gS8ZCeRDglHox8DAwAgCXy9x7A0MCu1EDAyMIxnJ3/eo6xFFYRKLgYGxKSMpYsuF5QBQLaQxMDD2ZszTuGrQ7JEuGGRiYGDcj/EDs77RP68mCYMAAAAASUVORK5CYII=">åˆ†äº«</a><div class="tags"><a href="/tags/Golang/"><i class="fa fa-tag"></i>Golang</a><a href="/tags/%E7%88%AC%E8%99%AB/"><i class="fa fa-tag"></i>çˆ¬è™«</a><a href="/tags/%E6%AD%A3%E6%96%B9%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F/"><i class="fa fa-tag"></i>æ­£æ–¹æ•™åŠ¡ç³»ç»Ÿ</a><a href="/tags/nginx/"><i class="fa fa-tag"></i>nginx</a></div><div class="post-nav"><a class="pre" href="/2021/11/07/Review-of-life-in-university/">Review of life in university âœ”</a><a class="next" href="/2021/09/03/%E6%96%B0%E7%89%88%E6%AD%A3%E6%96%B9%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0/">æ–°ç‰ˆæ­£æ–¹æ•™åŠ¡ç³»ç»Ÿç™»å½•å®ç°</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=1.1.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=1.1.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=1.1.0"></script><script>var gitalk = new Gitalk({
  clientID: '0a5a339e4c6a3cc81b76',
  clientSecret: 'ce2b79ca94465b2a758faca9e0b95e4df38d6204',
  repo: 'FarmerChillax.github.io',
  owner: 'FarmerChillax',
  admin: ['FarmerChillax'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AD%A6%E4%BA%86%E4%BA%9B%E4%BB%80%E4%B9%88/">å­¦äº†äº›ä»€ä¹ˆ</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%90%9E%E4%BA%8B%E6%83%85/">æäº‹æƒ…</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%83%A1%E6%80%9D%E4%B9%B1%E8%AF%AD/">èƒ¡æ€ä¹±è¯­</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/Golang/" style="font-size: 15px;">Golang</a> <a href="/tags/%E8%83%A1%E8%A8%80%E4%B9%B1%E8%AF%AD/" style="font-size: 15px;">èƒ¡è¨€ä¹±è¯­</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" style="font-size: 15px;">è®¡ç®—æœºç½‘ç»œåŸºç¡€</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">ç¬”è®°</a> <a href="/tags/%E7%88%AC%E8%99%AB/" style="font-size: 15px;">çˆ¬è™«</a> <a href="/tags/%E6%AD%A3%E6%96%B9%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F/" style="font-size: 15px;">æ­£æ–¹æ•™åŠ¡ç³»ç»Ÿ</a> <a href="/tags/nginx/" style="font-size: 15px;">nginx</a> <a href="/tags/CTF/" style="font-size: 15px;">CTF</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">Cè¯­è¨€</a> <a href="/tags/%E5%88%B7%E9%A2%98/" style="font-size: 15px;">åˆ·é¢˜</a> <a href="/tags/PTA/" style="font-size: 15px;">PTA</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 15px;">å‰ç«¯</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/%E7%AE%97%E6%B3%95%E5%92%8C%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 15px;">ç®—æ³•å’Œæ•°æ®ç»“æ„</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/%E4%BD%8D%E8%BF%90%E7%AE%97/" style="font-size: 15px;">ä½è¿ç®—</a> <a href="/tags/%E5%93%88%E5%B8%8C%E8%A1%A8/" style="font-size: 15px;">å“ˆå¸Œè¡¨</a> <a href="/tags/Sliding-Window/" style="font-size: 15px;">Sliding Window</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 15px;">é“¾è¡¨</a> <a href="/tags/DDNS/" style="font-size: 15px;">DDNS</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E8%AE%B0%E5%BD%95/" style="font-size: 15px;">ç”Ÿæ´»è®°å½•</a> <a href="/tags/%E5%90%90%E6%A7%BD/" style="font-size: 15px;">åæ§½</a> <a href="/tags/%E9%BB%91%E6%9A%97%E6%96%99%E7%90%86/" style="font-size: 15px;">é»‘æš—æ–™ç†</a> <a href="/tags/TypeScript/" style="font-size: 15px;">TypeScript</a> <a href="/tags/vs-code/" style="font-size: 15px;">vs code</a> <a href="/tags/%E6%8F%92%E4%BB%B6/" style="font-size: 15px;">æ’ä»¶</a> <a href="/tags/Flask-APIFlask/" style="font-size: 15px;">Flask/APIFlask</a> <a href="/tags/emotion/" style="font-size: 15px;">emotion</a> <a href="/tags/Rust/" style="font-size: 15px;">Rust</a> <a href="/tags/%E8%93%9D%E6%A1%A5%E6%9D%AF/" style="font-size: 15px;">è“æ¡¥æ¯</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/03/15/%E7%94%9F%EF%BC%8C%E6%B4%BB/">ç”Ÿï¼Œæ´»</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/03/09/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%94%A8APIFlask%E5%81%9A%E6%AF%95%E4%B8%9A%E8%AE%BE%E8%AE%A1%E2%80%94%E2%80%94%E5%90%8E%E7%AB%AF/">æ‰‹æŠŠæ‰‹æ•™ä½ ç”¨APIFlaskåšæ¯•ä¸šè®¾è®¡åç«¯â€”åŸºæœ¬ç®€ä»‹ä¸Hello APIFlask!(ä¸€)</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/01/15/%E7%94%A8Rust%E4%B8%BAPython%E5%8A%A0%E5%8F%8C%E7%BF%85%E8%86%80/">ç”¨Rustä¸ºPythonåŠ åŒç¿…è†€</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/12/08/%E7%A7%8B%E6%8B%9B%E6%9D%82%E8%B0%88/">æ ¡æ‹›æ‚è°ˆ</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/11/07/Review-of-life-in-university/">Review of life in university âœ”</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/05/A-distributed-with-Go/">A distributed system with Go</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/03/%E6%96%B0%E7%89%88%E6%AD%A3%E6%96%B9%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0/">æ–°ç‰ˆæ­£æ–¹æ•™åŠ¡ç³»ç»Ÿç™»å½•å®ç°</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/20/Golang%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95%E7%AC%94%E8%AE%B0/">GolangåŸºç¡€è¯­æ³•ç¬”è®° | æ•°ç»„ã€åˆ‡ç‰‡&æ˜ å°„</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/07/%E6%8F%90%E9%97%AE%E4%B8%AD%E9%9C%80%E8%A6%81%E9%81%BF%E5%85%8D%E7%9A%84%E4%B8%80%E4%BA%9B%E8%A1%8C%E4%B8%BA/">æé—®ä¸­éœ€è¦é¿å…çš„ä¸€äº›è¡Œä¸º</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/08/02/Leetcode-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%A2%98%E7%9B%AE%E9%9B%86%E7%9A%84%E6%9C%80%E5%90%8E%E4%B8%80%E5%A4%A9/">[Leetcode]æ•°æ®ç»“æ„é¢˜ç›®é›†çš„æœ€åä¸€å¤©</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="https://blog.xiaotao233.top/" title="å’¸é±¼çš„çª" target="_blank">å’¸é±¼çš„çª</a><ul></ul><a href="https://blog.diyxi.top/" title="DIYï¼Œç†™!" target="_blank">DIYï¼Œç†™!</a><ul></ul><a href="https://darkroom.vip/" title="Darkçš„å°é»‘å±‹" target="_blank">Darkçš„å°é»‘å±‹</a><ul></ul><a href="https://blog.ziki2333.top/" title="ziki" target="_blank">ziki</a><ul></ul><a href="https://blog.feldan.top/" title="feldan" target="_blank">feldan</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2022 <a href="/." rel="nofollow">Farmer.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.1.0" async></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.1.0" async></script><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="å¤åˆ¶æˆåŠŸ!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.1.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.1.0"></script></div></body></html>